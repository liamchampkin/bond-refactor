{spawn, exec}   = require 'child_process'
fs              = require 'fs'

module.exports = (template, locals, callback) ->
  if typeof locals == "function"
    callback  = locals
    locals    = {}
  locals    ||= {}
  
  command   = spawn 'ruby', ["#{__dirname}/index.rb"]
  json      = JSON.stringify(template: template, locals: locals)
  command.stdout.setEncoding('utf8')
  command.stdout.on 'data', (data) -> 
    callback(null, data.toString().trim())
  command.stdout.setEncoding('utf8')
  command.stderr.on 'data', (data) -> 
    callback data.toString().trim(), null
  command.stdin.write json
  command.stdin.end()